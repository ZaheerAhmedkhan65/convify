<!-- views/index.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Convify - Image Converter</title>
  <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',    // Professional blue
                        secondary: '#0ea5e9',  // Light blue
                        accent: '#10b981',     // Medical green
                        neutral: '#374151',    // Dark gray
                        light: '#f8fafc',       // Light background
                        pink: '#f87171',       // Light red
                    }
                }
            }
        }
    </script>
  <link href="/styles.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
  <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-3xl">
    <h1 class="text-3xl font-bold mb-6 text-center text-indigo-600">Convify</h1>

    <!-- Drop zone -->
    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:border-indigo-500 transition">
      <p class="text-gray-500">Drag & drop images here or click to select</p>
      <input id="fileInput" type="file" multiple accept="image/*" class="hidden" />
    </div>

    <!-- Image preview list -->
    <div id="previewContainer" class="mt-6 space-y-4 hidden"></div>

    <!-- Overall progress -->
    <div id="overallProgressContainer" class="hidden mt-6">
      <p class="text-sm text-gray-700 mb-2 font-medium">Overall Progress</p>
      <div class="w-full bg-gray-200 rounded-full h-3">
        <div id="overallProgressBar" class="bg-indigo-600 h-3 rounded-full" style="width: 0%;"></div>
      </div>
    </div>

    <!-- Convert button -->
    <button id="convertBtn"
      class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg w-full font-semibold mt-6">
      Convert All
    </button>
  </div>

 <script>
  const dropZone = document.getElementById("dropZone");
  const fileInput = document.getElementById("fileInput");
  const previewContainer = document.getElementById("previewContainer");
  const convertBtn = document.getElementById("convertBtn");
  const overallBar = document.getElementById("overallProgressBar");
  const overallContainer = document.getElementById("overallProgressContainer");

  let files = [];

  function formatBytes(bytes) {
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    if (bytes === 0) return '0 Byte';
    const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
    return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
  }

  dropZone.addEventListener("click", () => fileInput.click());
  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("border-indigo-500", "bg-indigo-50");
  });
  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("border-indigo-500", "bg-indigo-50");
  });
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("border-indigo-500", "bg-indigo-50");
    handleFiles(e.dataTransfer.files);
  });
  fileInput.addEventListener("change", (e) => handleFiles(e.target.files));

  function handleFiles(selectedFiles) {
    files = Array.from(selectedFiles);
    previewContainer.innerHTML = "";
    previewContainer.classList.remove("hidden");

    files.forEach((file, index) => {
      const fileURL = URL.createObjectURL(file);
      const fileFormat = file.name.split('.').pop().toUpperCase();
      const div = document.createElement("div");
      div.className = "flex items-center justify-between border rounded-lg p-3 shadow-sm";
      div.innerHTML = `
        <div class="flex items-center space-x-4">
          <img src="${fileURL}" class="w-16 h-16 object-cover rounded-lg border" alt="preview">
          <div>
            <p class="font-semibold text-gray-700">${file.name}</p>
            <p class="text-sm text-gray-500">${formatBytes(file.size)} • ${fileFormat}</p>
          </div>
        </div>
        <div class="text-right">
          <select id="format-${index}" class="border rounded-lg p-1 text-sm">
            <option value="png">PNG</option>
            <option value="jpg">JPG</option>
            <option value="webp">WEBP</option>
          </select>
          <div class="w-32 bg-gray-200 rounded-full h-2 mt-2">
            <div id="progress-${index}" class="bg-indigo-600 h-2 rounded-full" style="width: 0%;"></div>
          </div>
          <a id="download-${index}" href="#" class="hidden text-indigo-600 text-sm mt-2 block font-semibold">⬇ Download</a>
        </div>
      `;
      previewContainer.appendChild(div);
    });
  }

  convertBtn.addEventListener("click", async () => {
    if (!files.length) return alert("Please upload at least one image.");
    overallContainer.classList.remove("hidden");

    let completed = 0;
    let allConverted = [];

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const format = document.getElementById(`format-${i}`).value;

      const formData = new FormData();
      formData.append("image", file);
      formData.append("format", format);

      await new Promise((resolve) => {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/convert", true);

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            document.getElementById(`progress-${i}`).style.width = percent + "%";
          }
        };

        xhr.onload = () => {
          completed++;
          const overallPercent = (completed / files.length) * 100;
          overallBar.style.width = overallPercent + "%";

          const res = JSON.parse(xhr.responseText);
          if (res.success) {
            allConverted.push(res.file);
            const dl = document.getElementById(`download-${i}`);
            dl.href = res.file;
            dl.download = res.name;
            dl.classList.remove("hidden");
          }
          resolve();
        };

        xhr.send(formData);
      });
    }

    // Add ZIP download button
    const zipBtn = document.createElement("a");
    zipBtn.href = "/download-zip";
    zipBtn.className = "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg w-full font-semibold mt-6 block text-center";
    zipBtn.textContent = "⬇ Download All (ZIP)";
    previewContainer.appendChild(zipBtn);

    alert("✅ All images converted successfully!");
  });
</script>

</body>
</html>
